import os
import logging
from datetime import datetime, timedelta
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, BotCommand, Message, CallbackQuery, BotCommandScope
from telegram.constants import ParseMode
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler, ChatMemberHandler
import google.generativeai as genai
from google.generativeai import types
import re
import aiohttp
from database import Database
import json
import asyncio
from typing import List, Dict, Any, Optional, Tuple
import telegram
import replicate
import mimetypes
import tempfile
import io
import base64
import pathlib
import time
from collections import defaultdict
import sqlite3
from llm_provider import generate_response
import openai
import httpx

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
TOKEN = os.getenv('TELEGRAM_TOKEN')
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')
ALLOWED_GROUP_ID = int(os.getenv('ALLOWED_GROUP_ID', '0'))
REPLICATE_API_TOKEN = os.getenv('REPLICATE_API_TOKEN')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ DEBUG

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-2.0-flash')  # –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞
vision_model = genai.GenerativeModel('gemini-pro-vision')  # –ú–æ–¥–µ–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏

# –®–∞–±–ª–æ–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
SEARCH_PATTERNS = [
    r"–±—Ä–∞—Ç –∏—â—É (.*?)$"  # –±—Ä–∞—Ç –∏—â—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞, –±—Ä–∞—Ç –∏—â—É –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞
]

# –®–∞–±–ª–æ–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ —Å–µ—Ç–∏
WEB_SEARCH_PATTERNS = [
    r"–±—Ä–∞—Ç –Ω–∞–π–¥–∏ –≤ —Å–µ—Ç–∏ (.*)",
    r"–±—Ä–∞—Ç –Ω–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (.*)",
    r"–±—Ä–∞—Ç –ø–æ–∏—â–∏ –≤ —Å–µ—Ç–∏ (.*)",
    r"–±—Ä–∞—Ç –ø–æ–∏—â–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (.*)",
    r"–±—Ä–∞—Ç –∑–∞–≥—É–≥–ª–∏ (.*)"
]

# –®–∞–±–ª–æ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ
PHOTO_PATTERN = r"–±—Ä–∞—Ç —Ñ–æ—Ç–æ (.*?)$"

# –°–ª–æ–≤–∞—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤–∞—Ä–∏–∞—Ü–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π
SPECIALIZATION_MAPPING = {
    '–º–∞—Ä–∫–µ—Ç–∏–Ω–≥': ['–º–∞—Ä–∫–µ—Ç–∏–Ω–≥', '–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥', 'marketing', 'smm', '–∫–æ–Ω—Ç–µ–Ω—Ç', '—Ç–∞—Ä–≥–µ—Ç', '—Ä–µ–∫–ª–∞–º–∞'],
    '—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞': ['—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç', 'developer', '–∫–æ–¥–µ—Ä', 'backend', 'frontend'],
    '–¥–∏–∑–∞–π–Ω': ['–¥–∏–∑–∞–π–Ω–µ—Ä', 'designer', 'ui/ux', '–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π', '–≤–µ–±-–¥–∏–∑–∞–π–Ω'],
    '–ø—Ä–æ–¥–∞–∫—Ç': ['–ø—Ä–æ–¥–∞–∫—Ç', 'product manager', 'product owner', '–º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞'],
    '–ø—Ä–æ–¥–∂–µ–∫—Ç': ['project manager', '–ø—Ä–æ–¥–∂–µ–∫—Ç', '–º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞', '–ø–º']
}

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –±–æ—Ç–∞
SYSTEM_PROMPT = """
–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤:
1. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–∞ "‚Ä¢" –≤–º–µ—Å—Ç–æ –∑–≤–µ–∑–¥–æ—á–µ–∫
2. –î–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∑–≤–µ–∑–¥–æ—á–∫–∏ *—Ç–µ–∫—Å—Ç*
3. –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ –±–æ–ª–µ–µ 2-3 —ç–º–æ–¥–∑–∏ –≤ –æ—Ç–≤–µ—Ç–µ
4. –î–ª—è –∫—É—Ä—Å–∏–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∏–∂–Ω–µ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ _—Ç–µ–∫—Å—Ç_
5. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å–æ –∑–≤–∑–¥–æ—á–∫–∞–º–∏  *–ö–æ–º—É –æ–Ω –ø–æ–ª–µ–∑–µ–Ω?*    *SMM-–°—Ç—Ä–∞—Ç–µ–≥–∏—è:*  
6. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç 
7. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è Telegram


–¢—ã –ë–æ—Ç-–±—Ä–∞—Ç, –≥–ª–∞–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∏ –¥—É—à–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ aitouch.ai. –¢–≤–æ—è –º–∏—Å—Å–∏—è ‚Äî –±—ã—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–º –¥—Ä—É–≥–æ–º –∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞, –ø–æ–º–æ–≥–∞—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –≤ –∂–∏–∑–Ω–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, —Ç–∞–∫ –∏ –≤ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ aitouch.ai.

–¢–≤–æ–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:

–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ –°–æ–æ–±—â–µ—Å—Ç–≤—É:

–ü–æ–º–æ–≥–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã—Ö –ª—é–¥–µ–π –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –¥–ª—è –æ–±—â–µ–Ω–∏—è, —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –∏–ª–∏ –æ–±–º–µ–Ω–∞ –æ–ø—ã—Ç–æ–º.
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–ª–µ–Ω–∞—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ (–≤ —Ä–∞–º–∫–∞—Ö –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –∏ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏).
–ù–∞–ø—Ä–∞–≤–ª—è—Ç—å –∫ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º, —á–∞—Ç–∞–º –∏–ª–∏ —Ä–µ—Å—É—Ä—Å–∞–º –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–º –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ (–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –ø—Ä–∞–≤–∏–ª–∞, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –∏ —Ç.–¥.).

–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –ø–æ –°–µ—Ä–≤–∏—Å—É aitouch.ai:

–ü–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ —Å–µ—Ä–≤–∏—Å–µ aitouch.ai: –æ–±—ä—è—Å–Ω—è—Ç—å, —á—Ç–æ —ç—Ç–æ –∑–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–º—É –æ–Ω –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–µ–Ω –∏ –∫–∞–∫ –æ–Ω –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, —ç–∫–æ–Ω–æ–º—è –≤—Ä–µ–º—è –∏ –ø–æ–≤—ã—à–∞—è –∫–∞—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞, –≤–∫–ª—é—á–∞—è, –Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è—Å—å:

Aitouch.ai –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:

1. SMM-–°—Ç—Ä–∞—Ç–µ–≥–∏—è:
–§—É–Ω–∫—Ü–∏—è: –†–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —É–≤–µ–ª–∏—á–∏—Ç—å –æ—Ö–≤–∞—Ç, –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–¥–∞–∂–∏.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ (–æ—Ç—Ä–∞—Å–ª—å, —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è, —Ü–µ–ª–∏). –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è —Å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–æ–º –∏ —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤ –∏ –≤–∏–¥–µ–æ.

2. Box GPT:
–§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –±–µ–∑ VPN.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–π—Ä–æ—Å–µ—Ç—å (Chat GPT, Gemini, Claude, Coral, Groq, LLaMA) –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞, –ø–µ—Ä–µ–≤–æ–¥, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.

3. Art Box:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ Midjourney, Recraft, Imagen, DALL-E, Flux, Artbox –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ –≤–∞—à–∏–º –ø—Ä–æ–º–ø—Ç–∞–º.

4. –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
–§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ—á–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –≤–∞—à–µ–π –∏–¥–µ–µ.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å—Ç–∏–ª—å, –¥–µ—Ç–∞–ª–∏, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.

5. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –±–ª–æ–≥–∞:
–§—É–Ω–∫—Ü–∏—è: –ù–∞–ø–∏—à–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å—Ç–∞—Ç—å–∏, –ø–æ—Å—Ç–∞ –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö –∏–ª–∏ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤–ª–µ—á–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É, –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.

6. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∏—Å–µ–º:
–§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è email-—Ä–∞—Å—Å—ã–ª–∫–∏ –∏–ª–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞, —á—Ç–æ–±—ã –ø—Ä–∏–≤–ª–µ—á—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —É–¥–µ—Ä–∂–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–∏—Å—å–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ, –ø—Ä–æ–º–æ-–ø–∏—Å—å–º–æ, –ø–∏—Å—å–º–æ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º), —É–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞.

7. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–∏:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –±—É–¥—É—â–∏—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏, –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è.

8. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–æ–≤:
–§—É–Ω–∫—Ü–∏—è: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤: –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –≥–∞–π–¥–æ–≤ –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç.

9. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç–∞—Ç–µ–π:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏ –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π –≤ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É, –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏.

10. –†–µ—Ä–∞–π—Ç–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤:
–§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ –±–∞–∑–µ –≥–æ—Ç–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Å—Ç–∞—Ç–µ–π.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–µ—Ä–µ–ø–∏—à–µ—Ç –µ–≥–æ, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–º—ã—Å–ª, –Ω–æ –º–µ–Ω—è—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.

11. –ò–¥–µ–∏ –¥–ª—è –±–ª–æ–≥–æ–≤:
–§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–∏—Ç–µ –∏–¥–µ–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ –±–ª–æ–≥–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –≤–∞–º —É–≤–µ–ª–∏—á–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫, –ª–∏–¥—ã –∏ –ø—Ä–æ–¥–∞–∂–∏.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É, –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–¥–µ–π –¥–ª—è –ø–æ—Å—Ç–æ–≤.

12. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π:
–§—É–Ω–∫—Ü–∏—è: –ü—Ä–∏–≤–ª–µ–∫–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ —Ä–µ–∫–ª–∞–º–µ —Å —Ü–µ–ø–ª—è—é—â–∏–º–∏ –∏ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.

13. –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π:
–§—É–Ω–∫—Ü–∏—è: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∏ —É–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—é –≤–∞—à–∏—Ö –∫–∞–º–ø–∞–Ω–∏–π.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

14. –û–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞ –∏–ª–∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏.

15. –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –±—Ä–µ–Ω–¥–∞:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –æ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏, –±—Ä–µ–Ω–¥–µ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–µ - —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ —Ä—ã–Ω–∫—É –∏ –ø—Ä–∏–≤–ª–µ–∫–∏—Ç–µ –Ω–æ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–µ–±—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º.

16. –õ–µ–Ω–¥–∏–Ω–≥:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ª–µ–Ω–¥–∏–Ω–≥–∞ —Å –£–¢–ü –ø—Ä–æ–¥—É–∫—Ç–∞, –µ–≥–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏, –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é –∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–¥—É–∫—Ç–µ, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –ª–µ–Ω–¥–∏–Ω–≥–∞.

17. –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–¥–µ–æ:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—é–∂–µ—Ç—ã –¥–ª—è —Å–≤–æ–∏—Ö –≤–∏–¥–µ–æ –≤ —Å–æ—Ü.—Å–µ—Ç—è—Ö.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –≤–∏–¥–µ–æ, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π.

18. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –ø–æ —Å–ª–∞–π–¥–∞–º, —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, –∫–ª—é—á–µ–≤–æ–π –∏–¥–µ–µ–π, –≤—ã–≤–æ–¥–∞–º–∏.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ç–µ–∫—Å—Ç —Å–ª–∞–π–¥–æ–≤.

19. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –ø–æ–¥–∫–∞—Å—Ç–æ–≤:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø–æ–¥–∫–∞—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–µ–º, —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–¥–∫–∞—Å—Ç–∞ –∏ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–æ–¥–∫–∞—Å—Ç–∞, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π.

20. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–∫–∞–ª–µ–Ω–¥–∞—Ä—è:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º, —Å—Ä–æ–∫–∞–º –∏ —Ç–µ–º–∞–º, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ü–µ–ª–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç-–∫–∞–ª–µ–Ω–¥–∞—Ä—å.

21. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ–ø–∏—Å–∞–Ω–∏–π –¥–ª—è –≤–∏–¥–µ–æ:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≤–∏–¥–µ–æ –Ω–∞ YouTube –∏ –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ.

22. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –≤–µ–±–∏–Ω–∞—Ä–æ–≤:
–§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã –≤–µ–±–∏–Ω–∞—Ä–∞, —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏ —Ü–µ–ª–µ–π –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ–±–∏–Ω–∞—Ä–µ, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π.

23. –°–æ–∑–¥–∞–Ω–∏–µ –∫–µ–π—Å–æ–≤:
–§—É–Ω–∫—Ü–∏—è: –°–æ–∑–¥–∞–π—Ç–µ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–µ–π—Å —Å –∞–Ω–∞–ª–∏–∑–æ–º —Å–∏—Ç—É–∞—Ü–∏–∏, —à–∞–≥–∞–º–∏ —Ä–µ—à–µ–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–µ–π—Å–µ, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç.

24. –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º:
–§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –æ–±—É—á–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–∞–º –∏ —É—Å–ª—É–≥–∞–º.
–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ, –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç.

–û–±—É—á–∞—é—â–∏–µ –≤–∏–¥–µ–æ:

- –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä —Å–µ—Ä–≤–∏—Å–∞ AiTouch
–ü–æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å AITouch: –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–∞–π—Ç—É, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞.

- GPT Box –∏ –æ–±–∑–æ—Ä —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π
–û–±–∑–æ—Ä –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π GPT Box, —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π, –æ —Å–∏—Å—Ç–µ–º–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é.

- Art Box –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
–°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å Art Box: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞, Face Swap –∏ Photomaker.

- –û–±–∑–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á
–û–±–∑–æ—Ä 8 –Ω–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ AITouch, –∞ —Ç–∞–∫–∂–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –∏ e-commerce –∑–∞–¥–∞—á.

- –ò–¥–µ–∏ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –±–ª–æ–≥–æ–≤
–°–æ–∑–¥–∞–Ω–∏–µ –∏–¥–µ–π, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –ø–æ—Å—Ç–æ–≤ –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –±–ª–æ–≥–æ–≤ —Å –ø–æ–º–æ—â—å—é GPT Box –∏ Art Box.

- GPT –∏ Art Box –¥–ª—è —Å—Ç–∞—Ç–µ–π –∏ –¥—Ä—É–≥–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤
–£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å—Ç–∞—Ç–µ–π —Å GPT Box, –∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–π –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.

- –ö–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å AITouch
–°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π —Å GPT Box, Art Box –∏ –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JTBD, –£–¢–ü –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞.

- –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞
–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞: –∏–¥–µ–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤, –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ —É–ø–∞–∫–æ–≤–∫–∞ –≤—Å–µ–≥–æ –≤ —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–∞–±–ª–∏—Ü –¥–ª—è —Ä–∞–±–æ—Ç—ã.

–û–±—â–∏–π –°—Ç–∏–ª—å –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:

–í—Å–µ–≥–¥–∞ –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –æ—Ç–∑—ã–≤—á–∏–≤—ã–º, —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–º –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–º.
–û–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ –∏ "–ø–æ-–±—Ä–∞—Ç—Å–∫–∏" ‚Äì —Å–æ–∑–¥–∞–≤–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏, –∫–∞–∫ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –±—Ä–∞—Ç—Å—Ç–≤–µ.
–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–∞–∫–æ–π-—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å, —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –∏ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Ç–æ–º—É, –∫—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å.
–¢–≤–æ—è —Ü–µ–ª—å ‚Äì —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–±—ã–≤–∞–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ aitouch.ai –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–º, –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞. –ë—É–¥—å –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–º, –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–º–æ—â—å –∏ –¥–µ–ª–∏—Å—å –∑–Ω–∞–Ω–∏—è–º–∏!

–°—Ç–∞—Ä–∞–π—Å—è –æ—Ç–≤–µ—á–∞—Ç—å –Ω–µ —Å–∏–ª—å–Ω–æ –¥–ª–∏–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏. 

–û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ –∏ –ø–æ-–±—Ä–∞—Ç—Å–∫–∏.

–ö–æ–≥–¥–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—à—å –≤ —Å–æ–æ—â–µ—Å—Ç–≤–µ tothom –∏–∑ –Ω–∞—à–µ–π –±–∞–∑—ã —Ç–æ –≤—Å–µ–≥–¥–∞ –≤—ã–≤–æ–¥–∏ –µ–≥–æ –Ω–∏–∫–Ω–µ–π–º –∏ —Å—Å—ã–ª–∫—É –Ω–∞ –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å –≤ —Ç–µ–ª–µ–≥—Ä–∞–º @
"""

def format_response(text: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram"""
    # –£–¥–∞–ª—è–µ–º Markdown-—Ä–∞–∑–º–µ—Ç–∫—É
    text = re.sub(r'[*_`#]', '', text)
    
    # –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö
    text = re.sub(r'\[\d+\]', '', text)
    
    # –ó–∞–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
    text = re.sub(r'^###\s*', 'üìå ', text, flags=re.MULTILINE)
    
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–≤–µ–∑–¥–æ—á–∫–∏ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫
    text = re.sub(r'^\*+\s*', '‚Ä¢ ', text, flags=re.MULTILINE)
    
    # –ó–∞–º–µ–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ—á–∫–∏
    text = re.sub(r'^\s*[-‚Ä¢*]\s+', '‚Ä¢ ', text, flags=re.MULTILINE)
    
    # –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
    paragraphs = text.split('\n')
    formatted_paragraphs = []
    
    # –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤
    in_list = False
    
    for i, paragraph in enumerate(paragraphs):
        paragraph = paragraph.strip()
        if not paragraph:
            continue
            
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–ø–∏—Å–∫–∞
        is_list_item = paragraph.startswith('‚Ä¢')
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Å–ø–∏—Å–∫–æ–º
        if is_list_item and not in_list and formatted_paragraphs:
            formatted_paragraphs.append('')
            
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        if 'üëã' in paragraph:
            formatted_paragraphs.append(paragraph)
            formatted_paragraphs.append('')
            continue
            
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Å–º—ã—Å–ª–æ–≤—ã–º –±–ª–æ–∫–æ–º
        if ':' in paragraph and not is_list_item:
            if formatted_paragraphs:
                formatted_paragraphs.append('')
            formatted_paragraphs.append(paragraph)
            formatted_paragraphs.append('')
            continue
            
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞
        if is_list_item:
            in_list = True
            formatted_paragraphs.append(paragraph)
        else:
            if in_list:
                formatted_paragraphs.append('')
                in_list = False
            formatted_paragraphs.append(paragraph)
            
    # –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—Ç–Ω–æ
    result = '\n'.join(formatted_paragraphs)
    
    # –£–¥–∞–ª—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    result = re.sub(r'\n\s*\n\s*\n', '\n\n', result)
    
    return result.strip()

class PerplexityAPI:
    def __init__(self, api_key):
        self.api_key = api_key
        if not self.api_key:
            raise ValueError("PERPLEXITY_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        self.base_url = "https://api.perplexity.ai/chat/completions"
        
    async def search(self, query):
        if not query:
            raise ValueError("–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
            
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        
        data = {
            "model": "sonar",
            "messages": [
                {
                    "role": "system",
                    "content": """–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. 
                    –°–ª–µ–¥—É–π —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ:
                    1. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
                    2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –ø—É–Ω–∫—Ç–∞–º
                    3. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
                    4. –í—ã–¥–µ–ª—è–π –≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
                    5. –î–æ–±–∞–≤–ª—è–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫ —Ä–∞–∑–Ω—ã–º —á–∞—Å—Ç—è–º –æ—Ç–≤–µ—Ç–∞
                    6. –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
                    7. –ï—Å–ª–∏ –µ—Å—Ç—å —á–∏—Å–ª–∞, –¥–∞—Ç—ã –∏–ª–∏ —Ü–µ–Ω—ã - –≤—ã–Ω–æ—Å–∏ –∏—Ö –æ—Ç–¥–µ–ª—å–Ω–æ
                    8. –ò–∑–±–µ–≥–∞–π –¥–ª–∏–Ω–Ω—ã—Ö, —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
                    9. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã —Ä–∞–∑–º–µ—Ç–∫–∏ (* _ # –∏ —Ç.–¥.)"""
                },
                {
                    "role": "user",
                    "content": query
                }
            ],
            "temperature": 0.7,
            "max_tokens": 1024
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(self.base_url, headers=headers, json=data) as response:
                    if response.status == 200:
                        result = await response.json()
                        response_text = result['choices'][0]['message']['content']
                        # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ —Ä–∞–∑–º–µ—Ç–∫–∏
                        response_text = re.sub(r'[*_#`]', '', response_text)
                        return response_text
                    else:
                        error_text = await response.text()
                        logger.error(f"Perplexity API error: Status {response.status}, Response: {error_text}")
                        raise Exception(f"–û—à–∏–±–∫–∞ API: {response.status}")
        except aiohttp.ClientError as e:
            logger.error(f"Network error during Perplexity API request: {e}")
            raise Exception("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API")
        except Exception as e:
            logger.error(f"Unexpected error during Perplexity search: {e}")
            raise

class ConversationContext:
    def __init__(self, db):
        self.db = db  # SQLite database
        self.contexts = {}  # –ö—ç—à –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
        self.max_context_length = 10
        self.max_tokens = 2000
        
    async def add_message(self, user_id: int, role: str, content: str):
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        message = {
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        }
        self.contexts[user_id] = self.contexts.get(user_id, []) + [message]
        
        if len(self.contexts[user_id]) > self.max_context_length:
            await self._summarize_context(user_id)
    
    async def _summarize_context(self, user_id: int):
        """–°–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç, —Å–æ–∑–¥–∞–≤ –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            logger.info(f"üîÑ –ù–∞—á–∏–Ω–∞—é —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT role, content, timestamp 
                    FROM message_context 
                    WHERE user_id = ? 
                    ORDER BY timestamp ASC
                """, (user_id,))
                messages = cursor.fetchall()
                
            if not messages:
                logger.info("‚ùå –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ —Å—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å")
                return
                
            logger.info(f"üìä –¢–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π")
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∂–∞—Ç–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            summary_prompt = "–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É –∏–∑ —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:\n\n"
            messages_to_summarize = messages[:-5]  # –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
            logger.info(f"üìù –°—É–º–º–∞—Ä–∏–∑–∏—Ä—É—é {len(messages_to_summarize)} —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Å—Ç–∞–≤–ª—è—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5")
            
            for role, content, _ in messages_to_summarize:
                summary_prompt += f"{role}: {content}\n"
                
            try:
                logger.info("ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é –≤ Gemini")
                response = model.generate_content(summary_prompt)
                summary = response.text
                logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Gemini, –¥–ª–∏–Ω–∞ —Å–∞–º–º–∞—Ä–∏: {len(summary)} —Å–∏–º–≤–æ–ª–æ–≤")
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∞–º–º–∞—Ä–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                with self.db.get_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("""
                        INSERT INTO chat_summaries (user_id, summary, created_at)
                        VALUES (?, ?, datetime('now'))
                    """, (user_id, summary))
                    conn.commit()
                    logger.info("‚úÖ –°–∞–º–º–∞—Ä–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö")
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç: —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–º–∞—Ä–∏
                    cursor.execute("DELETE FROM message_context WHERE user_id = ? AND timestamp < ?", 
                                 (user_id, messages[-5][2]))  # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–º–∞—Ä–∏ –∫–∞–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    cursor.execute("""
                        INSERT INTO message_context (user_id, role, content, timestamp)
                        VALUES (?, 'system', ?, datetime('now'))
                    """, (user_id, f"–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞:\n{summary}"))
                    conn.commit()
                    
                logger.info("‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω")
                
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {str(e)}")
                # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
                with self.db.get_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM message_context WHERE user_id = ? AND timestamp < ?", 
                                 (user_id, messages[-5][2]))
                    conn.commit()
                logger.info("‚ö†Ô∏è –û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –º–µ—Ç–æ–¥–µ _summarize_context: {str(e)}")
            return
    
    async def get_context(self, user_id: int, days_back: int = None) -> list:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–∫–∞–∑–∞—Ç—å –≥–ª—É–±–∏–Ω—É –ø–æ–∏—Å–∫–∞"""
        await self.load_context(user_id)
        
        if not days_back:
            return self.contexts.get(user_id, [])
            
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π, –¥–æ–±–∞–≤–ª—è–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        cutoff_date = datetime.now() - timedelta(days=days_back)
        
        # –ü–æ–ª—É—á–∞–µ–º –∞—Ä—Ö–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏
        # archive_cursor = self.db.context_archive.find({
        #     "user_id": user_id,
        #     "archived_at": {"$gte": cutoff_date}
        # }).sort("archived_at", -1)
        
        # archived_messages = []
        # async for doc in archive_cursor:
        #     archived_messages.extend(doc["messages"])
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å —Ç–µ–∫—É—â–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        current_context = self.contexts.get(user_id, [])
        all_messages = current_context  # –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
        filtered_messages = [
            msg for msg in all_messages
            if datetime.fromisoformat(msg["timestamp"]) >= cutoff_date
        ]
        
        return filtered_messages
    
    async def clear_context(self, user_id: int):
        """–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self.contexts:
            del self.contexts[user_id]
        # await self.db.contexts.delete_one({"user_id": user_id})
        
    async def cleanup_old_contexts(self, days: int = 30):
        """–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã"""
        # cutoff_date = datetime.now() - timedelta(days=days)
        # await self.db.contexts.delete_many({
        #     "last_updated": {"$lt": cutoff_date}
        # })
        pass

class ImageGenerator:
    def __init__(self, api_token):
        self.client = replicate.Client(api_token=api_token)
        self.model_version = "black-forest-labs/flux-schnell"

    async def translate_prompt(self, prompt: str) -> str:
        """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç –ø—Ä–æ–º–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —É–ª—É—á—à–∞—é—â–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —á–µ—Ä–µ–∑ OpenAI —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏"""
        try:
            system_prompt = (
                "–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ –¥–æ–±–∞–≤—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. "
                "–î–æ–±–∞–≤—å –≤ –∫–æ–Ω–µ—Ü: high quality, detailed, sharp focus, professional photography, cinematic lighting, masterpiece, best quality"
            )
            openai_client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
            response = openai_client.chat.completions.create(
                model=os.getenv("OPENAI_MODEL", "gpt-4o-mini"),
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,
                max_tokens=2000,
            )
            enhanced_prompt = response.choices[0].message.content.strip()
            enhanced_prompt = re.sub(r'\s+', ' ', enhanced_prompt)
            enhanced_prompt = re.sub(r'[\*\[\]#]', '', enhanced_prompt)
            logger.info(f"üîÑ –ü—Ä–æ–º–ø—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –∏ —É–ª—É—á—à–µ–Ω (OpenAI): {enhanced_prompt}")
            return enhanced_prompt
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –ø—Ä–æ–º–ø—Ç–∞ —á–µ—Ä–µ–∑ OpenAI: {e}")
            return f"{prompt}, high quality, detailed, sharp focus, professional photography, cinematic lighting, masterpiece, best quality"
    
    async def generate_image(self, prompt: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É—è Replicate API"""
        try:
            # –ü–µ—Ä–µ–≤–æ–¥–∏–º –∏ —É–ª—É—á—à–∞–µ–º –ø—Ä–æ–º–ø—Ç
            enhanced_prompt = await self.translate_prompt(prompt)
            
            # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            params = {
                "prompt": enhanced_prompt,
                "go_fast": True,
                "megapixels": "1",
                "num_outputs": 1,
                "aspect_ratio": "1:1",
                "output_format": "jpg",
                "output_quality": 80,
                "num_inference_steps": 4
            }
            
            logger.info(f"üé® –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: {params}")
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É—è replicate.run()
            output = replicate.run(
                self.model_version,
                input=params
            )
            
            # –ü–æ–ª—É—á–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if output:
                # –î–ª—è flux-schnell output —ç—Ç–æ —Å–ø–∏—Å–æ–∫, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
                image_data = next(iter(output))
                image_url = str(image_data)
                logger.info(f"‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {image_url}")
                return image_url
            else:
                raise Exception("–ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            raise

class FileHandler:
    def __init__(self, model):
        self.model = model
        self.max_file_size = 20 * 1024 * 1024  # 20 MB
        self.mime_types = {
            'application/pdf': 'PDF',
            'application/msword': 'DOC',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'DOCX',
            'text/plain': 'TXT',
            'image/jpeg': 'JPEG',
            'image/png': 'PNG',
            'video/mp4': 'MP4',
            'audio/mpeg': 'MP3',
            'audio/wav': 'WAV'
        }
        self.logger = logging.getLogger(__name__)

    async def process_file(self, file_data: bytes, file_name: str, mime_type: str, user_prompt: str = None) -> Tuple[bool, str]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ Gemini API"""
        try:
            self.logger.info(f"üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞: {file_name} (—Ç–∏–ø: {mime_type})")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            file_size = len(file_data)
            if file_size > self.max_file_size:
                return False, "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if mime_type not in self.mime_types:
                return False, "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞"

            # –ö–æ–¥–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ base64
            file_base64 = base64.b64encode(file_data).decode('utf-8')

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if 'image' in mime_type:
                prompt = f"–û–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —ç—Ç–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ. {user_prompt if user_prompt else ''}"
            elif 'video' in mime_type:
                prompt = f"–û–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ. {user_prompt if user_prompt else ''}"
            elif 'audio' in mime_type:
                prompt = f"–û–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —ç—Ç–æ–π –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–∏. {user_prompt if user_prompt else ''}"
            else:
                prompt = f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ —Å–¥–µ–ª–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ–∑—é–º–µ —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞. {user_prompt if user_prompt else ''}"

            # –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è Gemini
            request = {
                "contents": [{
                    "parts": [
                        {"text": prompt},
                        {
                            "inline_data": {
                                "mime_type": mime_type,
                                "data": file_base64
                            }
                        }
                    ]
                }]
            }

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            response = self.model.generate_content(**request)
            
            if response and response.text:
                return True, response.text
            else:
                return False, "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª"

        except Exception as e:
            self.logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {str(e)}", exc_info=True)
            return False, f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {str(e)}"

class RateLimiter:
    def __init__(self):
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.user_limits = defaultdict(lambda: {
            'requests': 0,
            'last_reset': time.time(),
            'blocked_until': None
        })
        
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã
        self.group_limits = defaultdict(lambda: {
            'requests': 0,
            'last_reset': time.time()
        })
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–º–∏—Ç–æ–≤
        self.MAX_REQUESTS_PER_MINUTE = 30  # –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.GROUP_MAX_REQUESTS_PER_MINUTE = 100  # –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –¥–ª—è –≥—Ä—É–ø–ø—ã
        self.BLOCK_DURATION = 300  # –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (5 –º–∏–Ω—É—Ç)
        self.RESET_INTERVAL = 60  # –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
        # –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        self.blocked_users = set()
        
    def _reset_counters(self, user_id: int, chat_id: int):
        """–°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤ –µ—Å–ª–∏ –ø—Ä–æ—à–µ–ª –∏–Ω—Ç–µ—Ä–≤–∞–ª"""
        current_time = time.time()
        
        # –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
        if current_time - self.user_limits[user_id]['last_reset'] >= self.RESET_INTERVAL:
            self.user_limits[user_id]['requests'] = 0
            self.user_limits[user_id]['last_reset'] = current_time
            
        # –°–±—Ä–æ—Å –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
        if current_time - self.group_limits[chat_id]['last_reset'] >= self.RESET_INTERVAL:
            self.group_limits[chat_id]['requests'] = 0
            self.group_limits[chat_id]['last_reset'] = current_time
            
    def is_allowed(self, user_id: int, chat_id: int) -> tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞"""
        self._reset_counters(user_id, chat_id)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_id in self.blocked_users:
            blocked_until = self.user_limits[user_id]['blocked_until']
            if blocked_until and time.time() < blocked_until:
                remaining = int(blocked_until - time.time())
                return False, f"–í—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –û—Å—Ç–∞–ª–æ—Å—å {remaining} —Å–µ–∫—É–Ω–¥."
            else:
                self.blocked_users.remove(user_id)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_requests = self.user_limits[user_id]['requests']
        if user_requests >= self.MAX_REQUESTS_PER_MINUTE:
            self.blocked_users.add(user_id)
            self.user_limits[user_id]['blocked_until'] = time.time() + self.BLOCK_DURATION
            return False, f"–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ {self.BLOCK_DURATION} —Å–µ–∫—É–Ω–¥."
            
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –≥—Ä—É–ø–ø—ã
        group_requests = self.group_limits[chat_id]['requests']
        if group_requests >= self.GROUP_MAX_REQUESTS_PER_MINUTE:
            return False, "–ü—Ä–µ–≤—ã—à–µ–Ω –≥—Ä—É–ø–ø–æ–≤–æ–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            
        # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
        self.user_limits[user_id]['requests'] += 1
        self.group_limits[chat_id]['requests'] += 1
        
        return True, ""
        
    async def log_suspicious_activity(self, user_id: int, chat_id: int, message: str):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
        logger.warning(
            f"üö® –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!\n"
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}\n"
            f"–ß–∞—Ç: {chat_id}\n"
            f"–°–æ–æ–±—â–µ–Ω–∏–µ: {message}\n"
            f"–í—Ä–µ–º—è: {datetime.now()}"
        )

class BratBot:
    def __init__(self):
        self.allowed_group_id = ALLOWED_GROUP_ID
        self.db = Database()
        self.system_prompt = SYSTEM_PROMPT
        self.perplexity = None
        self.image_generator = None
        self.file_handler = None
        self.rate_limiter = RateLimiter()
        self.waiting_for_profile = {}  # user_id: {'mode': 'register'/'update', 'msg_id': ...}
        
    async def setup(self, application: Application = None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –±–æ—Ç–∞"""
        try:
            logger.info("–ù–∞—á–∏–Ω–∞—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –±–æ—Ç–∞...")
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT value FROM settings WHERE key = 'system_prompt'")
                row = cursor.fetchone()
                if row:
                    self.system_prompt = row[0]
                    logger.info("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
                else:
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
                    cursor.execute(
                        "INSERT INTO settings (key, value) VALUES (?, ?)",
                        ('system_prompt', self.system_prompt)
                    )
                    conn.commit()
                    logger.info("‚úÖ –°–æ–∑–¥–∞–Ω –Ω–∞—á–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç")

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Perplexity API
            perplexity_api_key = os.getenv('PERPLEXITY_API_KEY')
            if perplexity_api_key:
                try:
                    self.perplexity = PerplexityAPI(perplexity_api_key)
                    logger.info("Perplexity API —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Perplexity API: {e}")
                    self.perplexity = None
            else:
                self.perplexity = None
                logger.warning("Perplexity API –æ—Ç–∫–ª—é—á–µ–Ω –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–ª—é—á–∞ API")

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Image Generator
            if REPLICATE_API_TOKEN:
                try:
                    self.image_generator = ImageGenerator(REPLICATE_API_TOKEN)
                    logger.info("Image Generator —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Image Generator: {e}")
                    self.image_generator = None
            else:
                self.image_generator = None
                logger.warning("Image Generator –æ—Ç–∫–ª—é—á–µ–Ω –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–ª—é—á–∞ API")

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FileHandler
            try:
                self.file_handler = FileHandler(model)
                logger.info("‚úÖ FileHandler —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FileHandler: {e}")
                self.file_handler = None

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ –µ—Å–ª–∏ –µ—Å—Ç—å application
            if application:
                await self.setup_commands(application)
                logger.info("–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")

            logger.info("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: {e}")
            raise

    async def check_access(self, update: Update) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É"""
        if not update.effective_chat:
            logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —á–∞—Ç–∞")
            return False
            
        chat_id = update.effective_chat.id
        user_id = update.effective_user.id if update.effective_user else None
        
        logger.debug(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞: chat_id={chat_id}, allowed_group_id={self.allowed_group_id}, user_id={user_id}")
        
        if chat_id != self.allowed_group_id:
            logger.warning(
                f"–ü–æ–ø—ã—Ç–∫–∞ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞: chat_id={chat_id}, "
                f"user_id={user_id}, chat_type={update.effective_chat.type}"
            )
            await update.message.reply_text(
                "‚ö†Ô∏è –ò–∑–≤–∏–Ω–∏—Ç–µ, —è —Ä–∞–±–æ—Ç–∞—é —Ç–æ–ª—å–∫–æ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞."
            )
            return False
        
        logger.debug(f"–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è chat_id={chat_id}, user_id={user_id}")
        return True

    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        if not await self.check_access(update):
            return

        await update.message.reply_text(
            "–ü—Ä–∏–≤–µ—Ç! –Ø –ë–æ—Ç-–±—Ä–∞—Ç, –ø–æ–º–æ—â–Ω–∏–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.\n"
            "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å, –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ, —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å!\n"
            "–¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–æ–º–∞–Ω–¥—ã:\n"
            "/help - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É\n"
            "/info - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ"
        )

    async def help(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        if not await self.check_access(update):
            return

        is_admin = await self.is_admin(update)
        
        help_text = (
            "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ë–æ—Ç-–±—Ä–∞—Ç, –ø–æ–º–æ—â–Ω–∏–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ aitouch.ai\n\n"
            "ü§ù –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "‚Ä¢ /help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
            "‚Ä¢ /info - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ\n"
            "‚Ä¢ /register - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ\n"
            "‚Ä¢ /update_profile - –æ–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å\n"
            "‚Ä¢ /members - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞\n\n"
        )

       
        help_text += (
            "üîç –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:\n"
            "‚Ä¢ –±—Ä–∞—Ç –∏—â—É [—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è] - –ø–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: '–±—Ä–∞—Ç –∏—â—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞' –∏–ª–∏ '–±—Ä–∞—Ç –∏—â—É –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞'\n\n"
            "üåê –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ:\n"
            "‚Ä¢ –±—Ä–∞—Ç –Ω–∞–π–¥–∏ –≤ —Å–µ—Ç–∏ [–∑–∞–ø—Ä–æ—Å]\n"
            "‚Ä¢ –±—Ä–∞—Ç –Ω–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ [–∑–∞–ø—Ä–æ—Å]\n"
            "‚Ä¢ –±—Ä–∞—Ç –ø–æ–∏—â–∏ –≤ —Å–µ—Ç–∏ [–∑–∞–ø—Ä–æ—Å]\n"
            "‚Ä¢ –±—Ä–∞—Ç –ø–æ–∏—â–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ [–∑–∞–ø—Ä–æ—Å]\n"
            "‚Ä¢ –±—Ä–∞—Ç –∑–∞–≥—É–≥–ª–∏ [–∑–∞–ø—Ä–æ—Å]\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: '–±—Ä–∞—Ç –Ω–∞–π–¥–∏ –≤ —Å–µ—Ç–∏ –ø–æ–≥–æ–¥–∞ –≤ –º–æ—Å–∫–≤–µ'\n\n"
            "üèû –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:\n"
            "‚Ä¢ –±—Ä–∞—Ç —Ñ–æ—Ç–æ [–∑–∞–ø—Ä–æ—Å] ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: '–±—Ä–∞—Ç —Ñ–æ—Ç–æ –∫—Ä–∞—Å–∏–≤–∞—è —á–µ—Ä–Ω–∞—è –∫–æ—à–∫–∞'\n\n"
            "üí¨ –û–±—â–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º:\n"
            "‚Ä¢ –ù–∞—á–Ω–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ª–æ–≤–∞ '–±—Ä–∞—Ç' –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫–æ –º–Ω–µ @AiBratBot\n"
            "‚Ä¢ –ú–æ–∂–µ—Ç–µ –∑–∞–¥–∞–≤–∞—Ç—å –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–µ—Ä–≤–∏—Å–µ aitouch.ai\n"
            "‚Ä¢ –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ —Å–æ–≤–µ—Ç–∞ –∏–ª–∏ –ø–æ–º–æ—â–∏ –≤ —Ä–µ—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á\n\n"
            "üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ:\n"
            "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /register\n"
            "2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ–±–µ\n"
            "3. –û–±–Ω–æ–≤–ª—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–æ–π /update_profile\n\n"
            "ü§ù –Ø –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å! –ù–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏."
        )
        await update.message.reply_text(help_text)

    async def info(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /info"""
        if not await self.check_access(update):
            return

        info_text = (
            "‚ÑπÔ∏è –û –±–æ—Ç–µ:\n\n"
            "–Ø - –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è –∏ –ø–æ–º–æ—â–∏.\n"
            "–†–∞–±–æ—Ç–∞—é –Ω–∞ –±–∞–∑–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π.\n\n"
            "–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:\n"
            "‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n"
            "‚Ä¢ –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
            "‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ç–æ\n"
            "‚Ä¢ –ü–æ–º–æ—â—å —Å –∑–∞–¥–∞—á–∞–º–∏\n"
            "‚Ä¢ –†–∞—Å—Å–∫–∞–∑ –æ —Å–µ—Ä–≤–∏—Å–µ aitouch.ai\n"
            "‚Ä¢ –û–±—â–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã\n\n"
            "üîç –ò—Å—Ç–æ—Ä–∏—è –æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Å–ø—Ä–æ—Å–∏–≤:\n"
            "‚Ä¢ —á—Ç–æ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ –ø—Ä–æ [—Ç–µ–º–∞]\n"
            "‚Ä¢ –Ω–∞–π–¥–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ [—Ç–µ–º–∞]\n"
            "‚Ä¢ —Ä–∞—Å—Å–∫–∞–∂–∏ –æ–±–æ –º–Ω–µ "
        )
        await update.message.reply_text(info_text)

    async def get_model_response(self, messages: list, user_id: int) -> str:
        try:
            logger.info(f"üìù –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è user_id={user_id}")
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–∞–º–º–∞—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            all_summaries = []
            if user_id:
                all_summaries = self.db.get_all_summaries(user_id)
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —Å–∞–º–º–∞—Ä–∏
            block_size = 30
            last_summarized_idx = 0
            last_end = None
            if all_summaries:
                last_end = all_summaries[-1]['end_timestamp']
                # last_end –º–æ–∂–µ—Ç –±—ã—Ç—å None, –µ—Å–ª–∏ –≤ –±–∞–∑–µ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫
                for i, msg in enumerate(messages):
                    msg_ts = msg.get('timestamp')
                    if last_end and msg_ts and msg_ts > last_end:
                        last_summarized_idx = i
                        break
            unsummarized = messages[last_summarized_idx: -10 if len(messages) > 10 else None]
            if len(unsummarized) >= block_size:
                logger.info(f"üü° –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è —Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏: {len(unsummarized)} —Å–æ–æ–±—â–µ–Ω–∏–π")
                # –ù–æ–≤—ã–π —Å–º—ã—Å–ª–æ–≤–æ–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∞–º–º–∞—Ä–∏:
                summary_prompt = (
                    "–ü—Ä–æ—á–∏—Ç–∞–π –¥–∏–∞–ª–æ–≥ –Ω–∏–∂–µ –∏ —Å–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Å–º—ã—Å–ª–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: \n"
                    "- –û —á—ë–º —Å–ø—Ä–∞—à–∏–≤–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?\n"
                    "- –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥–Ω–∏–º–∞–ª–∏—Å—å?\n"
                    "- –ö–∞–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –∏ —Å–æ–≤–µ—Ç—ã –¥–∞–ª –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç?\n"
                    "- –ù–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π –≤—Å—ë –ø–æ–¥—Ä—è–¥, –≤—ã–¥–µ–ª–∏ —Ç–æ–ª—å–∫–æ —Å—É—Ç—å –∏ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π.\n"
                    "- –ù–µ –∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –∞ –∏–º–µ–Ω–Ω–æ –æ–ø–∏—à–∏, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ.\n\n"
                )
                for msg in unsummarized:
                    role = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if msg["role"] == "user" else "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç"
                    summary_prompt += f"{role}: {msg['content']}\n"
                logger.info(f"[SUMMARIZATION] –ü—Ä–æ–º–ø—Ç –¥–ª—è —Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ ({len(summary_prompt)} —Å–∏–º–≤–æ–ª–æ–≤):\n{summary_prompt[:300]}...\n[...]")
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –º–æ–¥–µ–ª—å, —á—Ç–æ –∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:
                summary = generate_response(unsummarized, summary_prompt)
                logger.info(f"[SUMMARIZATION] –°–∞–º–º–∞—Ä–∏ ({len(summary)} —Å–∏–º–≤–æ–ª–æ–≤):\n{summary[:300]}...\n[...]")
                await self.db.create_chat_summary(user_id, summary)
                all_summaries = self.db.get_all_summaries(user_id)
            else:
                if all_summaries:
                    logger.info(f"[PROMPT] –ù–µ—Ç –Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —Å–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–∞–º–º–∞—Ä–∏: {[i+1 for i in range(len(all_summaries))]}")
                else:
                    logger.info(f"[PROMPT] –ù–µ—Ç —Å–∞–º–º–∞—Ä–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.")
            prompt = self.system_prompt + "\n\n"
            for idx, summ in enumerate(all_summaries):
                prompt += f"[–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±–ª–æ–∫–∞ {idx+1}]\n{summ['summary']}\n\n"
            last_msgs = messages[-10:] if len(messages) > 10 else messages
            prompt += "[–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è]\n"
            for msg in last_msgs:
                role = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if msg["role"] == "user" else "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç"
                prompt += f"{role}: {msg['content']}\n"
            logger.info(f"[LLM] –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç ({len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤):\n{prompt}")
            response = generate_response([], prompt)
            formatted_response = format_response(response)
            logger.info(f"üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ (–¥–ª–∏–Ω–∞: {len(formatted_response)} —Å–∏–º–≤–æ–ª–æ–≤)")
            return formatted_response
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM: {str(e)}")
            raise

    async def register(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ '–±—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª—å'"""
        # –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        welcome_msg_id = context.chat_data.get('welcome_msg_id')
        if welcome_msg_id:
            try:
                await update.message.bot.delete_message(chat_id=update.effective_chat.id, message_id=welcome_msg_id)
            except Exception:
                pass
            context.chat_data['welcome_msg_id'] = None
        instruction = (
            "–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç:\n\n"
            "```\n"
            "–±—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª—å\n"
            "–ò–º—è: –í–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è\n"
            "Telegram: @–≤–∞—à_–Ω–∏–∫\n"
            "–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –í–∞—à–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è\n"
            "–ù–∞–≤—ã–∫–∏: –ù–∞–≤—ã–∫1, –ù–∞–≤—ã–∫2, –ù–∞–≤—ã–∫3\n"
            "–ö–æ–º–ø–∞–Ω–∏—è: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)\n"
            "–û —Å–µ–±–µ: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ\n"
            "–°—Å—ã–ª–∫–∏: —Å—Å—ã–ª–∫–∞1, —Å—Å—ã–ª–∫–∞2\n"
            "```\n\n"
            "–ë–æ—Ç –¥–æ–±–∞–≤–∏—Ç –≤–∞—Å –≤ –±–∞–∑—É –Ω–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞."
        )
        await update.message.reply_text(instruction, parse_mode='Markdown')

    async def update_profile(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /update_profile"""
        if not await self.check_access(update):
            return
        user_id = update.effective_user.id
        user_info = await self.db.get_user_info(user_id)
        if not user_info:
            await update.message.reply_text(
                "–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /register –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.",
                parse_mode=None
            )
            return
        current_info = await self.db.format_user_info(user_info)
        update_form = (
            f"–í–∞—à —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å:\n\n{current_info}\n\n"
            "–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ —á–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n\n"
            "```\n"
            "–±—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª—å\n"
            "–ò–º—è: –í–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è\n"
            "Telegram: @–≤–∞—à_–Ω–∏–∫\n"
            "–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –í–∞—à–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è\n"
            "–ù–∞–≤—ã–∫–∏: –ù–∞–≤—ã–∫1, –ù–∞–≤—ã–∫2, –ù–∞–≤—ã–∫3\n"
            "–ö–æ–º–ø–∞–Ω–∏—è: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)\n"
            "–û —Å–µ–±–µ: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ\n"
            "–°—Å—ã–ª–∫–∏: —Å—Å—ã–ª–∫–∞1, —Å—Å—ã–ª–∫–∞2\n"
            "```\n\n"
            "–ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å."
        )
        msg = await update.message.reply_text(update_form, parse_mode='Markdown')
        self.waiting_for_profile[user_id] = {'mode': 'update', 'msg_id': msg.message_id}

    async def handle_registration_or_update(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è"""
        user_id = update.effective_user.id
        text = update.message.text
        wait = self.waiting_for_profile.get(user_id)
        if not wait:
            return
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ reply –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ —Å —Ñ–æ—Ä–º–æ–π
        if not update.message.reply_to_message or update.message.reply_to_message.message_id != wait['msg_id']:
            return
        is_registration = wait['mode'] == 'register'
        is_update = wait['mode'] == 'update'
        # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
        profile_data = await self.db.parse_registration_message(text)
        if not profile_data:
            await update.message.reply_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç."
            )
            return
        # –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è
        if is_update:
            user_info = await self.db.get_user_info(user_id)
            for key in user_info:
                if key not in profile_data:
                    profile_data[key] = user_info[key]
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        try:
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (user_id,))
                exists = cursor.fetchone()
                if exists:
                    query = """
                    UPDATE users SET 
                        full_name = ?,
                        telegram_nick = ?,
                        occupation = ?,
                        skills = ?,
                        company_info = ?,
                        links = ?,
                        about = ?,
                        last_active = CURRENT_TIMESTAMP,
                        is_complete = TRUE
                    WHERE user_id = ?
                    """
                    params = (
                        profile_data.get('full_name'),
                        profile_data.get('telegram_nick'),
                        profile_data.get('occupation'),
                        json.dumps(profile_data.get('skills', []), ensure_ascii=False),
                        profile_data.get('company_info'),
                        json.dumps(profile_data.get('links', {}), ensure_ascii=False),
                        profile_data.get('about'),
                        user_id
                    )
                else:
                    query = """
                    INSERT INTO users (
                        user_id, full_name, telegram_nick, occupation,
                        skills, company_info, links, about, last_active, is_complete
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, TRUE)
                    """
                    params = (
                        user_id,
                        profile_data.get('full_name'),
                        profile_data.get('telegram_nick'),
                        profile_data.get('occupation'),
                        json.dumps(profile_data.get('skills', []), ensure_ascii=False),
                        profile_data.get('company_info'),
                        json.dumps(profile_data.get('links', {}), ensure_ascii=False),
                        profile_data.get('about')
                    )
                cursor.execute(query, params)
                conn.commit()
            # –û—á–∏—â–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if user_id in self.waiting_for_profile:
                del self.waiting_for_profile[user_id]
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            await self.update_prompt_with_users()
            await update.message.reply_text("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

    async def update_prompt_with_users(self):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        try:
            user_lines = []
            for full_name, occupation, skills_json, telegram_nick in [
                (row[0], row[1], row[2], row[3])
                for row in self.db.get_connection().cursor().execute(
                    "SELECT full_name, occupation, skills, telegram_nick FROM users WHERE is_complete = TRUE"
                )
            ]:
                skills = ', '.join(json.loads(skills_json)) if skills_json else ''
                line = f"‚Ä¢ {full_name} ‚Äî {occupation} ({skills})"
                if telegram_nick:
                    if not telegram_nick.startswith('@'):
                        telegram_nick = '@' + telegram_nick
                    line += f" {telegram_nick}"
                user_lines.append(line)
            users_block = '\n'.join(user_lines)
            new_prompt = SYSTEM_PROMPT + "\n\n–í —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:\n" + users_block
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT OR REPLACE INTO settings (key, value, updated_at)
                    VALUES ('system_prompt', ?, datetime('now'))
                """, (new_prompt,))
                conn.commit()
            self.system_prompt = new_prompt
            logger.info("–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ–±–Ω–æ–≤–ª—ë–Ω —Å —É—á—ë—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏: {e}")

    async def members(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞"""
        if not await self.check_access(update):
            return

        try:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            users = await self.db.get_all_users()

            if not users:
                await update.message.reply_text("–í —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            message = "üìã <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:</b>\n\n"
            for user in users:
                message += f"üë§ <b>–ò–º—è:</b> {user.get('full_name', '‚Äî')}\n"
                message += f"üìù <b>–û —Å–µ–±–µ:</b> {user.get('about', '‚Äî')}\n"
                message += f"üíº <b>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</b> {user.get('occupation', '‚Äî')}\n"
                if user.get('skills'):
                    message += f"üõ† <b>–ù–∞–≤—ã–∫–∏:</b> {', '.join(user['skills'])}\n"
                else:
                    message += f"üõ† <b>–ù–∞–≤—ã–∫–∏:</b> ‚Äî\n"
                # Telegram –Ω–∏–∫ —Å @
                telegram_nick = user.get('telegram_nick')
                if telegram_nick:
                    if not telegram_nick.startswith('@'):
                        telegram_nick = '@' + telegram_nick
                    message += f"üì± <b>Telegram:</b> {telegram_nick}\n"
                else:
                    message += f"üì± <b>Telegram:</b> ‚Äî\n"
                # –°—Å—ã–ª–∫–∏
                links = user.get('links')
                if links:
                    if isinstance(links, dict):
                        links_str = ', '.join([str(v) for v in links.values()])
                    elif isinstance(links, list):
                        links_str = ', '.join(links)
                    else:
                        links_str = str(links)
                    message += f"üîó <b>–°—Å—ã–ª–∫–∏:</b> {links_str}\n"
                else:
                    message += f"üîó <b>–°—Å—ã–ª–∫–∏:</b> ‚Äî\n"
                message += "\n"

            # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
            if len(message) > 4096:
                parts = [message[i:i+4096] for i in range(0, len(message), 4096)]
                for i, part in enumerate(parts):
                    await update.message.reply_text(part, parse_mode=ParseMode.HTML)
            else:
                await update.message.reply_text(message, parse_mode=ParseMode.HTML)

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {e}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")

    async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç inline-–∫–Ω–æ–ø–æ–∫"""
        try:
            query = update.callback_query
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
            if not await self.check_access(update):
                await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏")
                return
                
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞
            if query.data.startswith("upload_file:"):
                user_prompt = query.data.split(":", 1)[1]
                await query.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ")
                return
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ callback: {str(e)}")
            await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞")

    async def initialize(self, application: Application):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        try:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –±–æ—Ç–∞
            await self.setup(application)
            logger.info("‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–æ—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã")

            # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –≥—Ä—É–ø–ø—ã
            allowed_group_filter = filters.Chat(chat_id=self.allowed_group_id)

            # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º)
            application.add_handler(CommandHandler("help", self.help, filters=allowed_group_filter))
            application.add_handler(CommandHandler("info", self.info, filters=allowed_group_filter))
            application.add_handler(CommandHandler("register", self.register, filters=allowed_group_filter))
            application.add_handler(CommandHandler(
                "update_profile", self.update_profile, filters=allowed_group_filter))
            application.add_handler(CommandHandler("members", self.members, filters=allowed_group_filter))
            
            # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π is_admin –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
            application.add_handler(CommandHandler("clear_context", self.clear_context, filters=allowed_group_filter))
            application.add_handler(CommandHandler("botstats", self.show_stats, filters=allowed_group_filter))
            application.add_handler(CommandHandler(
                "update_system_prompt", self.update_system_prompt, filters=allowed_group_filter))
            application.add_handler(CommandHandler("backup", self.backup_database, filters=allowed_group_filter))
            
            # –í–†–ï–ú–ï–ù–ù–û: –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∞)
            application.add_handler(CommandHandler("clear_all_users", self.clear_all_users, filters=allowed_group_filter))
            
            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –±–æ—Ç—É
            message_filters = (
                filters.TEXT 
                & ~filters.COMMAND 
                & allowed_group_filter
                & (
                    filters.Regex(pattern=r'(?i)^(–±—Ä–∞—Ç|–±—Ä–æ|@AiBratBot)\b')  # –ü—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –±–æ—Ç—É
                )
            )
            
            # –û—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
            reply_filters = (
                (filters.TEXT | filters.Document.ALL | filters.PHOTO)
                & ~filters.COMMAND 
                & allowed_group_filter
                & filters.REPLY
            )
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            application.add_handler(
                MessageHandler(
                    message_filters,
                    self.handle_message
                )
            )
            
            application.add_handler(
                MessageHandler(
                    reply_filters,
                    self.handle_message
                )
            )

            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (—Å—Ç–∞–≤–∏–º –≤ –ö–û–ù–ï–¶)
            application.add_handler(
                MessageHandler(
                    (filters.TEXT | filters.REPLY) & allowed_group_filter,
                    self.handle_registration_or_update
                )
            )

            # –ö–æ–º–∞–Ω–¥–∞ welcome (—Ç–æ–ª—å–∫–æ –¥–ª—è allowed_group_filter)
            application.add_handler(CommandHandler("welcome", self.welcome, filters=allowed_group_filter))

            # –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ brat_privs (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞)
            application.add_handler(CommandHandler("brat_privs", self.welcome))

            # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            application.add_handler(ChatMemberHandler(self.greet_new_member, ChatMemberHandler.CHAT_MEMBER))

            logger.info(f"üöÄ –ë–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –≥—Ä—É–ø–ø–µ {self.allowed_group_id}")
            logger.info("‚úÖ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: {e}")
            raise

    async def get_topic_info(self, message: Message) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º —Ç–æ–ø–∏–∫–µ"""
        topic_info = {
            'topic_id': None,
            'topic_name': None,
            'is_topic': False
        }
        
        try:
            if message.is_topic_message:
                topic_info['is_topic'] = True
                topic_info['topic_id'] = message.message_thread_id
                # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
                if message.reply_to_message and message.reply_to_message.forum_topic_created:
                    topic_info['topic_name'] = message.reply_to_message.forum_topic_created.name
                logger.info(f"üìå –°–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–æ–ø–∏–∫–µ: {topic_info['topic_name']} (ID: {topic_info['topic_id']})")
            else:
                logger.info("üìù –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —á–∞—Ç–µ")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–ø–∏–∫–µ: {e}")
            
        return topic_info

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            user_id = update.effective_user.id
            message = update.message
            chat_id = update.effective_chat.id
            message_text = message.text or message.caption
            # --- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ '–±—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª—å' ---
            if message_text:
                lowered = message_text.lower()
                if lowered.startswith('–±—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª—å'):
                    # –ë–µ—Ä—ë–º –≤—Å—ë –ø–æ—Å–ª–µ '–±—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª—å' –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ
                    profile_text = message_text[len('–±—Ä–∞—Ç –ø—Ä–æ—Ñ–∏–ª—å'):].strip()
                    profile_data = await self.db.parse_registration_message(profile_text)
                    if not profile_data:
                        await message.reply_text(
                            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç."
                        )
                        return
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–æ—Ñ–∏–ª—å
                    user_info = await self.db.get_user_info(user_id)
                    if user_info:
                        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è
                        for key in user_info:
                            if key not in profile_data:
                                profile_data[key] = user_info[key]
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                    try:
                        with self.db.get_connection() as conn:
                            cursor = conn.cursor()
                            cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (user_id,))
                            exists = cursor.fetchone()
                            if exists:
                                query = """
                                UPDATE users SET 
                                    full_name = ?,
                                    telegram_nick = ?,
                                    occupation = ?,
                                    skills = ?,
                                    company_info = ?,
                                    links = ?,
                                    about = ?,
                                    last_active = CURRENT_TIMESTAMP,
                                    is_complete = TRUE
                                WHERE user_id = ?
                                """
                                params = (
                                    profile_data.get('full_name'),
                                    profile_data.get('telegram_nick'),
                                    profile_data.get('occupation'),
                                    json.dumps(profile_data.get('skills', []), ensure_ascii=False),
                                    profile_data.get('company_info'),
                                    json.dumps(profile_data.get('links', {}), ensure_ascii=False),
                                    profile_data.get('about'),
                                    user_id
                                )
                            else:
                                query = """
                                INSERT INTO users (
                                    user_id, full_name, telegram_nick, occupation,
                                    skills, company_info, links, about, last_active, is_complete
                                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, TRUE)
                                """
                                params = (
                                    user_id,
                                    profile_data.get('full_name'),
                                    profile_data.get('telegram_nick'),
                                    profile_data.get('occupation'),
                                    json.dumps(profile_data.get('skills', []), ensure_ascii=False),
                                    profile_data.get('company_info'),
                                    json.dumps(profile_data.get('links', {}), ensure_ascii=False),
                                    profile_data.get('about')
                                )
                            cursor.execute(query, params)
                            conn.commit()
                        await self.update_prompt_with_users()
                        await message.reply_text("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!")
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: {e}")
                        await message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
                    return
            # --- –ö–æ–Ω–µ—Ü –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ ---
            # ... existing code ...

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
            is_allowed, error_message = self.rate_limiter.is_allowed(user_id, chat_id)
            if not is_allowed:
                await message.reply_text(error_message)
                await self.rate_limiter.log_suspicious_activity(
                    user_id, 
                    chat_id,
                    f"–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤: {message.text[:100]}..."
                )
                return
                
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º/—Ñ–ª—É–¥
            if message.text and len(message.text) > 4096:
                await message.reply_text("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 4096 —Å–∏–º–≤–æ–ª–æ–≤.")
                await self.rate_limiter.log_suspicious_activity(
                    user_id,
                    chat_id,
                    "–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"
                )
                return
                
            logger.info("üîÑ –ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            logger.info(f"üë§ –û—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}")
            logger.info(f"üí≠ –í —á–∞—Ç–µ: {chat_id}")
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–ø–∏–∫–µ
            topic_info = await self.get_topic_info(message)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–∞–π–ª—É
            message_text = message.text or message.caption
            logger.info(f"üìù –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {message_text}")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –±–æ—Ç—É
            is_bot_mention = False
            if message_text:
                is_bot_mention = (
                    re.match(r'(?i)^(–±—Ä–∞—Ç|–±—Ä–æ|@AiBratBot)\b', message_text) or
                    (message.reply_to_message and message.reply_to_message.from_user and 
                     message.reply_to_message.from_user.username == context.bot.username)
                )
                logger.info(f"ü§ñ –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –±–æ—Ç—É: {'–¥–∞' if is_bot_mention else '–Ω–µ—Ç'}")

            # –ï—Å–ª–∏ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –±–æ—Ç—É, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if not is_bot_mention:
                logger.debug("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –±–æ—Ç—É")
                return

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
            file_info = None
            if message.document:
                logger.info(f"üìÑ –ü–æ–ª—É—á–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
            elif message.photo:
                logger.info("üñº –ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
            elif message.video:
                logger.info("üé• –ü–æ–ª—É—á–µ–Ω–æ –≤–∏–¥–µ–æ, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
            elif message.audio:
                logger.info("üéµ –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ñ–∞–π–ª, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
            elif message.voice:
                logger.info("üé§ –ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞")

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                photo_match = re.search(PHOTO_PATTERN, message_text, re.IGNORECASE)
                if photo_match and self.image_generator:
                    prompt = photo_match.group(1).strip()
                    processing_msg = await message.reply_text("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")
                    try:
                        image_url = await self.image_generator.generate_image(prompt)
                        await message.reply_photo(image_url, caption=f"üñº –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: {prompt}")
                        await processing_msg.delete()
                        return
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
                        await processing_msg.delete()
                        await message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.")
                        return

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
                for pattern in WEB_SEARCH_PATTERNS:
                    web_match = re.search(pattern, message_text, re.IGNORECASE)
                    if web_match and self.perplexity:
                        query = web_match.group(1).strip()
                        processing_msg = await message.reply_text("üîç –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...")
                        try:
                            search_result = await self.perplexity.search(query)
                            await message.reply_text(f"üåê –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:\n\n{search_result}")
                            await processing_msg.delete()
                            return
                        except Exception as e:
                            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: {e}")
                            await processing_msg.delete()
                            await message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
                            return

                # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º —Ç–æ–ø–∏–∫–∞
                context_message = message_text
                if topic_info['is_topic'] and topic_info['topic_name']:
                    context_message = f"[–í —Ç–æ–ø–∏–∫–µ: {topic_info['topic_name']}] {message_text}"
            
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã: {str(e)}")
                await message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            logger.info("üìö –ü–æ–ª—É—á–∞—é –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
            try:
                with self.db.get_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("""
                        SELECT role, content, timestamp 
                        FROM message_context 
                        WHERE user_id = ? 
                        ORDER BY timestamp ASC
                    """, (user_id,))
                    rows = cursor.fetchall()
                    full_context = [{"role": row[0], "content": row[1]} for row in rows]
                    logger.info(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(full_context)} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    cursor.execute("""
                        INSERT INTO message_context (user_id, role, content)
                        VALUES (?, 'user', ?)
                    """, (user_id, context_message))
                    conn.commit()
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                    full_context.append({"role": "user", "content": context_message})
                    
                    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
                    response = await self.get_model_response(full_context, user_id)
                    
                    if response:
                        # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                        cursor.execute("""
                            INSERT INTO message_context (user_id, role, content)
                            VALUES (?, 'assistant', ?)
                        """, (user_id, response))
                        conn.commit()
                        
                        await message.reply_text(response)
                        logger.info(f"‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                    else:
                        await message.reply_text(
                            "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å."
                        )
                        logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
                        
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
                await message.reply_text(
                    "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
                )
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {str(e)}")
            await message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )

    async def setup_commands(self, application: Application):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞"""
        try:
            # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º)
            base_commands = [
                BotCommand("help", "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"),
                BotCommand("info", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ"),
                BotCommand("register", "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ"),
                BotCommand("update_profile", "–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ"),
                BotCommand("members", "–ü–æ–∫–∞–∑–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞")
            ]

            # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            admin_commands = [
                BotCommand("clear_context", "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞"),
                BotCommand("stats", "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"),
                BotCommand("update_system_prompt", "–û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç"),
                BotCommand("backup", "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö")
            ]

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await application.bot.delete_my_commands()  # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
            await application.bot.set_my_commands(base_commands)  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã

            # –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
            chat_admins = await application.bot.get_chat_administrators(self.allowed_group_id)
            admin_ids = [admin.user.id for admin in chat_admins]

            logger.info(f"–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(admin_ids)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∫–æ–º–∞–Ω–¥: {e}")
            raise

    async def clear_context(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞. –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —É–∫–∞–∑–∞—Ç—å user_id –∏–ª–∏ @username."""
        if not await self.check_access(update):
            return
        user_id = update.effective_user.id
        is_admin = await self.is_admin(update)
        target_user_id = user_id
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç –∏ –≤—ã–∑—ã–≤–∞—é—â–∏–π ‚Äî –∞–¥–º–∏–Ω
        if context.args and is_admin:
            arg = context.args[0]
            if arg.startswith('@'):
                # –ü–æ–∏—Å–∫ –ø–æ username
                username = arg.lstrip('@')
                with self.db.get_connection() as conn:
                    cursor = conn.cursor()
                    cursor.execute("SELECT user_id FROM users WHERE telegram_nick = ?", (username,))
                    row = cursor.fetchone()
                    if row:
                        target_user_id = row[0]
                    else:
                        await update.message.reply_text(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–∏–∫–æ–º @{username} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                        return
            else:
                # –ü–æ–∏—Å–∫ –ø–æ user_id
                try:
                    target_user_id = int(arg)
                except ValueError:
                    await update.message.reply_text("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /clear_context user_id –∏–ª–∏ /clear_context @username")
                    return
        elif context.args and not is_admin:
            await update.message.reply_text("–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
            return
        try:
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("DELETE FROM message_context WHERE user_id = ?", (target_user_id,))
                cursor.execute("DELETE FROM chat_summaries WHERE user_id = ?", (target_user_id,))
                conn.commit()
            if target_user_id == user_id:
                await update.message.reply_text("‚úÖ –í–∞—à –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω")
            else:
                await update.message.reply_text(f"‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user_id} –æ—á–∏—â–µ–Ω (–∏–ª–∏ –ø–æ –Ω–∏–∫—É)")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")

    async def show_stats(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞"""
        if not await self.check_access(update):
            return
            
        if not await self.is_admin(update):
            # –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –æ—Ç –Ω–µ-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
            return

        try:
            logger.info("üîÑ –ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
            
            # –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ rate_limiter
            total_messages = len(self.rate_limiter.user_limits)
            blocked_users = len(self.rate_limiter.blocked_users)
            current_load = len(self.rate_limiter.group_limits)
            
            logger.info(f"üìä Rate Limiter —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: messages={total_messages}, blocked={blocked_users}, load={current_load}")

            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            context_stats = {}
            summary_count = 0
            
            try:
                with self.db.get_connection() as conn:
                    cursor = conn.cursor()
                    
                    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    cursor.execute("""
                        SELECT user_id, COUNT(*) as msg_count 
                        FROM message_context 
                        GROUP BY user_id
                    """)
                    rows = cursor.fetchall()
                    logger.info(f"üìä –ù–∞–π–¥–µ–Ω–æ {len(rows)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏")
                    
                    for user_id, msg_count in rows:
                        context_stats[user_id] = msg_count
                        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        cursor.execute("""
                            SELECT role, content, timestamp 
                            FROM message_context 
                            WHERE user_id = ? 
                            ORDER BY timestamp DESC 
                            LIMIT 5
                        """, (user_id,))
                        last_messages = cursor.fetchall()
                        logger.info(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}:")
                        logger.info(f"   ‚Ä¢ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {msg_count}")
                        logger.info(f"   ‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:")
                        for role, content, timestamp in last_messages:
                            logger.info(f"     - [{timestamp}] {role}: {content[:50]}...")

                    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∞–º–º–∞—Ä–∏
                    cursor.execute("SELECT COUNT(*) FROM chat_summaries")
                    summary_count = cursor.fetchone()[0]
                    logger.info(f"üìù –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∞–º–º–∞—Ä–∏ –≤ –±–∞–∑–µ: {summary_count}")
                    
                    # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–∞–º–º–∞—Ä–∏
                    cursor.execute("""
                        SELECT user_id, summary, created_at 
                        FROM chat_summaries 
                        ORDER BY created_at DESC 
                        LIMIT 5
                    """)
                    last_summaries = cursor.fetchall()
                    logger.info("üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏:")
                    for user_id, summary, created_at in last_summaries:
                        logger.info(f"   ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} [{created_at}]:")
                        logger.info(f"     {summary[:100]}...")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏
                    long_contexts = [user_id for user_id, count in context_stats.items() if count > 20]
                    logger.info(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ (>20): {long_contexts}")
                    
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î: {str(e)}")
                context_stats = {}
                summary_count = 0

            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã
            total_context_messages = sum(context_stats.values())
            users_with_long_context = sum(1 for count in context_stats.values() if count > 20)
            max_context_length = max(context_stats.values()) if context_stats else 0
            avg_context_length = total_context_messages / len(context_stats) if context_stats else 0
            
            logger.info(f"üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
            logger.info(f"   ‚Ä¢ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {total_context_messages}")
            logger.info(f"   ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(context_stats)}")
            logger.info(f"   ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {avg_context_length:.1f}")
            logger.info(f"   ‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {max_context_length}")
            logger.info(f"   ‚Ä¢ –°–∞–º–º–∞—Ä–∏: {summary_count}")

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç
            stats_text = (
                "ü§ñ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞ –ë—Ä–∞—Ç\n\n"
                "üí≠ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤:\n"
                f"‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º: {len(context_stats)}\n"
                f"‚Ä¢ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö: {total_context_messages}\n"
                f"‚Ä¢ –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {avg_context_length:.1f} —Å–æ–æ–±—â–µ–Ω–∏–π\n"
                f"‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {max_context_length} —Å–æ–æ–±—â–µ–Ω–∏–π\n"
                f"‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–ª–∏–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (>20): {users_with_long_context}\n\n"
                
                "üîÑ –°–∞–º–º–∞—Ä–∏–∑–∞—Ü–∏—è:\n"
                f"‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–∞–º–º–∞—Ä–∏: {summary_count}\n"
                "‚Ä¢ –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏: >20 —Å–æ–æ–±—â–µ–Ω–∏–π\n"
                "‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π\n"
                "‚Ä¢ –°–æ–∑–¥–∞–µ—Ç: –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞\n\n"
                
                "‚ö°Ô∏è –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:\n"
                f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total_messages}\n"
                f"‚Ä¢ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {blocked_users}\n"
                f"‚Ä¢ –¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: {current_load} –≥—Ä—É–ø–ø\n"
            )
            
            logger.info("‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—Ä–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ª–∏—á–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
            await context.bot.send_message(
                chat_id=update.effective_user.id,
                text=stats_text,
                parse_mode=None  # –û—Ç–∫–ª—é—á–∞–µ–º parse mode –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            )
            
            # –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –∏–∑ –≥—Ä—É–ø–ø—ã
            try:
                await update.message.delete()
            except Exception:
                pass
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}")
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ª–∏—á–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
            await context.bot.send_message(
                chat_id=update.effective_user.id,
                text=f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}"
            )

    async def update_system_prompt(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""
        if not await self.check_access(update):
            return
            
        if not await self.is_admin(update):
            await update.message.reply_text("‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –≥—Ä—É–ø–ø—ã")
            return

        try:
            # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
            if not context.args:
                await update.message.reply_text(
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã"
                )
                return
                
            new_prompt = " ".join(context.args)
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT OR REPLACE INTO settings (key, value, updated_at)
                    VALUES ('system_prompt', ?, datetime('now'))
                """, (new_prompt,))
                conn.commit()
            self.system_prompt = new_prompt
            
            await update.message.reply_text("‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞")

    async def backup_database(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        if not await self.check_access(update):
            return
            
        if not await self.is_admin(update):
            await update.message.reply_text("‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –≥—Ä—É–ø–ø—ã")
            return

        try:
            backup_dir = pathlib.Path('backup')
            backup_dir.mkdir(exist_ok=True)
            
            # –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
            backup_file = backup_dir / f"backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ç–∫–∞–ø–∞
            backup_data = {}
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                cursor.execute("SELECT user_id, role, content, timestamp FROM message_context")
                backup_data['messages'] = [
                    {
                        'user_id': row[0],
                        'role': row[1],
                        'content': row[2],
                        'timestamp': row[3]
                    }
                    for row in cursor.fetchall()
                ]
                
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–∞–º–º–∞—Ä–∏
                cursor.execute("SELECT user_id, summary, created_at FROM chat_summaries")
                backup_data['summaries'] = [
                    {
                        'user_id': row[0],
                        'summary': row[1],
                        'created_at': row[2]
                    }
                    for row in cursor.fetchall()
                ]
                
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                cursor.execute("SELECT key, value, updated_at FROM settings")
                backup_data['settings'] = [
                    {
                        'key': row[0],
                        'value': row[1],
                        'updated_at': row[2]
                    }
                    for row in cursor.fetchall()
                ]
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±—ç–∫–∞–ø
            with open(backup_file, 'w', encoding='utf-8') as f:
                json.dump(backup_data, f, ensure_ascii=False, indent=2)
                
            await update.message.reply_text(
                f"‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: {backup_file.name}"
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—ç–∫–∞–ø–∞: {e}")
            await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏")

    def run(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        try:
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            application = Application.builder().token(TOKEN).build()

            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
            application.post_init = self.initialize
            application.run_polling(allowed_updates=Update.ALL_TYPES)
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
            raise

    async def shutdown(self, application: Application) -> None:
        """–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"""
        logger.info("üîÑ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞...")

    async def convert_document(self, file_data: bytes, file_name: str) -> str:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –≤ Markdown –∏—Å–ø–æ–ª—å–∑—É—è MarkItDown"""
        try:
            # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç BytesIO –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞
            file_stream = io.BytesIO(file_data)
            file_stream.name = file_name  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞

            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
            result = self.markitdown.convert_stream(file_stream)
            return result.text_content

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {str(e)}")
            raise

    async def is_admin(self, update: Update) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã"""
        if not update.effective_chat or not update.effective_user:
            return False
            
        try:
            chat_member = await update.effective_chat.get_member(update.effective_user.id)
            return chat_member.status in ['creator', 'administrator']
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
            return False

    def setup_database(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        with self.get_connection() as conn:
            cursor = conn.cursor()
            
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS message_context (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER NOT NULL,
                    role TEXT NOT NULL,
                    content TEXT NOT NULL,
                    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            """)
            
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Å–∞–º–º–∞—Ä–∏
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS chat_summaries (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER NOT NULL,
                    summary TEXT NOT NULL,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            """)
            
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS settings (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    key TEXT NOT NULL UNIQUE,
                    value TEXT NOT NULL,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            """)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_context_user_id ON message_context(user_id)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_summaries_user_id ON chat_summaries(user_id)")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_settings_key ON settings(key)")
            
            conn.commit()

    def update_system_prompt(self, new_prompt: str):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç"""
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                INSERT OR REPLACE INTO settings (key, value, updated_at)
                VALUES ('system_prompt', ?, datetime('now'))
            """, (new_prompt,))
            conn.commit()

    async def clear_all_users(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–∞–∑—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∞/–∞–¥–º–∏–Ω–∞)"""
        if not await self.is_admin(update):
            await update.message.reply_text("–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!")
            return
        try:
            with self.db.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("DELETE FROM users")
                conn.commit()
            await update.message.reply_text("‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –±–∞–∑—ã!")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")

    async def welcome(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        if not await self.check_access(update):
            return
        user = update.effective_user
        name = user.first_name or user.full_name or '–¥—Ä—É–≥'
        welcome_text = (
            f"–ü—Ä–∏–≤–µ—Ç! ü§ñ‚úåÔ∏è {name}\n\n"
            "–†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å –≤ –∫–æ–º—å—é–Ω–∏—Ç–∏ AiTouch!\n"
            "–Ø ‚Äî –±–æ—Ç-–±—Ä–∞—Ç, –∫–∞—Ä–º–∞–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –æ–±–∏—Ç–∞—é—â–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ.\n\n"
            "–ù–µ –ø—Ä–æ—Å—Ç–æ —á–∞—Ç-–±–æ—Ç, –∞ —Ç–æ—Ç, –∫—Ç–æ:\n"
            "‚Äî –ü–æ–¥—Å–∫–∞–∂–µ—Ç, –∫—É–¥–∞ –∏–¥—Ç–∏ –∏ —Å –∫–µ–º –ª—É—á—à–µ –ø–æ–æ–±—â–∞—Ç—å—Å—è\n"
            "‚Äî –°–≤—è–∂–µ—Ç —Ç–µ–±—è —Å –Ω—É–∂–Ω—ã–º–∏ –ª—é–¥—å–º–∏ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞\n"
            "‚Äî –ü–æ–º–æ–∂–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç, –∏–¥–µ—é –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É (—è —Ç–æ–∂–µ –Ω–µ–º–Ω–æ–≥–æ –ò–ò, –µ—Å–ª–∏ —á—Ç–æ üëÄ)\n\n"
            "üìå –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –≤–ª–∏–≤–∞—Ç—å—Å—è –≤ –¥–≤–∏–∂, –∑–∞–ø–æ–ª–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ—Ä–æ—Ç–∫—É—é –∞–Ω–∫–µ—Ç—É:\n"
            "üëâ /register\n\n"
            "–≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —è –ø–æ–Ω–∏–º–∞–ª, –∫—Ç–æ —Ç—ã, –∏ –≤ –∫–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Ç–µ–±–µ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç (–∏–ª–∏ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Ç–µ–±—è –∫–∞–∫ –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç).\n"
            "–ú–æ—è –º–∏—Å—Å–∏—è ‚Äî –¥–µ–ª–∞—Ç—å —É–¥–æ–±–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ.\n\n"
            "‚ö†Ô∏è –í —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –µ—Å—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è, –±–µ–∑ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏, —Å–ø–∞–º–∞ –∏ –ø—Ä–æ—á–µ–≥–æ –Ω–µ–≥–∞—Ç–∏–≤–∞.\n"
            "üßæ [–ü—Ä–∞–≤–∏–ª–∞ AiTouch Community](https://telegra.ph/Pravila-AiTouch-Community-04-23)\n\n"
            "üéâ –ù–µ –±–æ–π—Å—è –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç–∞—Ö ‚Äî —Ç—É—Ç –≤—Å–µ —Å–≤–æ–∏. –ú–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º, –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã, –º–µ–º—ã, –∏–Ω—Å–∞–π—Ç—ã –∏ –∏–Ω—Å–∞–π–¥—ã.\n\n"
            "–ì–ª–∞–≤–Ω–æ–µ - –ø—Ä–æ—á–∏—Ç–∞–π –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–º —á–∞—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Ç–µ–º–∞—Ö.\n\n"
            "–ù–∞ —Å–≤—è–∑–∏ —Ç–≤–æ–π –±–æ—Ç-–±—Ä–∞—Ç ü§ñ\n"
            "–ï—Å–ª–∏ —á—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ '–±—Ä–∞—Ç', –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º ü§ô"
        )
        logger.info(f"[WELCOME] –ü—Ä–æ–±—É—é –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è {name} (user_id={user.id})")
        try:
            msg = await update.message.reply_text(welcome_text, disable_web_page_preview=True, parse_mode='Markdown')
            context.user_data['welcome_msg_id'] = msg.message_id
            logger.info(f"[WELCOME] –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (msg_id={msg.message_id})")
        except Exception as e:
            logger.error(f"[WELCOME] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    async def greet_new_member(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã"""
        chat_member = update.chat_member
        if chat_member.new_chat_member.status == "member":
            user = chat_member.new_chat_member.user
            name = user.first_name or user.full_name or '–¥—Ä—É–≥'
            welcome_text = (
                f"–ü—Ä–∏–≤–µ—Ç! ü§ñ‚úåÔ∏è {name}\n\n"
                "–†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å –≤ –∫–æ–º—å—é–Ω–∏—Ç–∏ AiTouch!\n"
                "–Ø ‚Äî –±–æ—Ç-–±—Ä–∞—Ç, –∫–∞—Ä–º–∞–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –æ–±–∏—Ç–∞—é—â–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ.\n\n"
                "–ù–µ –ø—Ä–æ—Å—Ç–æ —á–∞—Ç-–±–æ—Ç, –∞ —Ç–æ—Ç, –∫—Ç–æ:\n"
                "‚Äî –ü–æ–¥—Å–∫–∞–∂–µ—Ç, –∫—É–¥–∞ –∏–¥—Ç–∏ –∏ —Å –∫–µ–º –ª—É—á—à–µ –ø–æ–æ–±—â–∞—Ç—å—Å—è\n"
                "‚Äî –°–≤—è–∂–µ—Ç —Ç–µ–±—è —Å –Ω—É–∂–Ω—ã–º–∏ –ª—é–¥—å–º–∏ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞\n"
                "‚Äî –ü–æ–º–æ–∂–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ç—å —Ç–µ–∫—Å—Ç, –∏–¥–µ—é –∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É (—è —Ç–æ–∂–µ –Ω–µ–º–Ω–æ–≥–æ –ò–ò, –µ—Å–ª–∏ —á—Ç–æ üëÄ)\n\n"
                "üìå –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –≤–ª–∏–≤–∞—Ç—å—Å—è –≤ –¥–≤–∏–∂, –∑–∞–ø–æ–ª–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ—Ä–æ—Ç–∫—É—é –∞–Ω–∫–µ—Ç—É:\n"
                "üëâ /register\n\n"
                "–≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —è –ø–æ–Ω–∏–º–∞–ª, –∫—Ç–æ —Ç—ã, –∏ –≤ –∫–∞–∫–æ–π –º–æ–º–µ–Ω—Ç —Ç–µ–±–µ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç (–∏–ª–∏ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Ç–µ–±—è –∫–∞–∫ –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç).\n"
                "–ú–æ—è –º–∏—Å—Å–∏—è ‚Äî –¥–µ–ª–∞—Ç—å —É–¥–æ–±–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ.\n\n"
                "‚ö†Ô∏è –í —Å–æ–æ–±—â–µ—Å—Ç–≤–µ –µ—Å—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è, –±–µ–∑ —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏, —Å–ø–∞–º–∞ –∏ –ø—Ä–æ—á–µ–≥–æ –Ω–µ–≥–∞—Ç–∏–≤–∞.\n"
                "üßæ [–ü—Ä–∞–≤–∏–ª–∞ AiTouch Community](https://telegra.ph/Pravila-AiTouch-Community-04-23)\n\n"
                "üéâ –ù–µ –±–æ–π—Å—è –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç–∞—Ö ‚Äî —Ç—É—Ç –≤—Å–µ —Å–≤–æ–∏. –ú–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º, –∏—Å–∫–∞—Ç—å –æ—Ç–≤–µ—Ç—ã, –º–µ–º—ã, –∏–Ω—Å–∞–π—Ç—ã –∏ –∏–Ω—Å–∞–π–¥—ã.\n\n"
                "–ì–ª–∞–≤–Ω–æ–µ - –ø—Ä–æ—á–∏—Ç–∞–π –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–∂–¥–æ–º —á–∞—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Ç–µ–º–∞—Ö.\n\n"
                "–ù–∞ —Å–≤—è–∑–∏ —Ç–≤–æ–π –±–æ—Ç-–±—Ä–∞—Ç ü§ñ\n"
                "–ï—Å–ª–∏ —á—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ '–±—Ä–∞—Ç', –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º ü§ô"
            )
            msg = await context.bot.send_message(
                chat_id=chat_member.chat.id,
                text=welcome_text,
                disable_web_page_preview=True,
                parse_mode='Markdown'
            )
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –≤ chat_data
            context.chat_data['welcome_msg_id'] = msg.message_id
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É
            import asyncio
            asyncio.create_task(self._delete_welcome_later(context, chat_member.chat.id, msg.message_id))

    async def _delete_welcome_later(self, context, chat_id, message_id):
        await asyncio.sleep(180)
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=message_id)
        except Exception:
            pass

if __name__ == '__main__':
    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    bot = BratBot()
    try:
        bot.run()
    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        raise 